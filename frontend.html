<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Imaging Protocol System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* BASE & LAYOUT */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6; /* Soft, professional background */
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            text-align: center;
            border-top: 5px solid #007bff; /* Primary color accent */
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            font-weight: 400;
        }
        
        /* MAIN CONTENT LAYOUT */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section, .results-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.6em;
            color: #007bff; /* Primary brand color */
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        /* FORM STYLES */
        .form-group {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #5d9cec; /* Light blue accent */
        }

        .form-group h3 {
            color: #2c3e50;
            margin-bottom: 18px;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            font-weight: 600;
            margin-bottom: 7px;
            color: #555;
            font-size: 0.95em;
        }

        .form-field input, .form-field select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        
        /* BUTTONS */
        .submit-btn {
            background: linear-gradient(45deg, #1abc9c, #16a085); /* Calming Teal/Green */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(26, 188, 156, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(26, 188, 156, 0.4);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        /* LOADING & ERROR */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading i {
            font-size: 3.5em;
            animation: spin 1s linear infinite;
            color: #007bff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-content {
            display: none;
        }

        .result-card {
            background: #fcfcfc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .result-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e0e0e0;
        }

        .protocol-item {
            background: #e8f7f8; /* Very light, calming background for protocols */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 5px solid #00bcd4; /* Cyan accent */
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        .protocol-item h5 {
            color: #007bff;
            margin-bottom: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .protocol-item p {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .renal-safety-note {
            background: #fff3e0; /* Light orange for caution */
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #ff9800;
            color: #e65100;
            font-size: 0.9em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        /* FHIR Specific Styles */
        #formModeBtn {
            background: #007bff !important; /* Distinct blue for mode switch */
            margin-bottom: 15px;
        }

        #formModeBtn:hover {
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        }

        #fileDropZone {
            border: 2px dashed #007bff;
            background-color: #f0f8ff; /* Light blue background for drop zone */
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            transition: border-color 0.3s, background-color 0.3s;
            cursor: pointer;
        }
        
        #fileDropZone:hover {
            border-color: #0056b3;
            background-color: #e0f0ff;
        }

        #fileInfo {
            display: none; 
            background: #e8f5e8; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 15px;
            border: 1px solid #c8e6c9;
            color: #2e7d32;
            font-weight: 500;
        }

        #clearFile {
            background: none; 
            border: none; 
            color: #e74c3c; 
            float: right; 
            cursor: pointer;
            font-size: 1.1em;
            transition: color 0.2s;
        }
        
        #clearFile:hover {
            color: #c0392b;
        }

        /* MEDIA QUERIES */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-microscope"></i> Medical Imaging Protocol System</h1>
            <p class="subtitle">Advanced AI-Powered Clinical Protocol Selection & Rationale</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">
                    <i class="fas fa-user-injured"></i>
                    Patient Data Input
                </h2>
                
                <div style="margin-bottom: 20px;">
                    <button type="button" id="formModeBtn" class="submit-btn" style="background: #007bff;">
                        <i class="fas fa-exchange-alt"></i>
                        Switch to FHIR Format Upload
                    </button>
                </div>
                
                <div id="standardForm">
                    <form id="patientForm">
                    <div class="form-group">
                        <h3><i class="fas fa-id-card-alt"></i> Patient Demographics</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Patient ID</label>
                                <input type="number" name="subject_id" placeholder="e.g., 10014729">
                            </div>
                            <div class="form-field">
                                <label>Age (years)</label>
                                <input type="number" name="age" placeholder="e.g., 21" min="0" max="150">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Gender</label>
                                <select name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="F">Female</option>
                                    <option value="M">Male</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>Race/Ethnicity</label>
                                <input type="text" name="race" placeholder="e.g., WHITE - EUROPEAN">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3><i class="fas fa-clinic-medical"></i> Admission Details</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Admission Type</label>
                                <select name="admission_type">
                                    <option value="">Select Type</option>
                                    <option value="EMERGENCY">Emergency</option>
                                    <option value="ELECTIVE">Elective</option>
                                    <option value="SURGICAL SAME DAY ADMISSION">Surgical Same Day</option>
                                    <option value="URGENT">Urgent</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>Primary Diagnosis</label>
                                <input type="text" name="primary_diagnosis" placeholder="e.g., Injury to thoracic aorta">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3><i class="fas fa-chart-line"></i> Vital Signs</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Heart Rate (bpm)</label>
                                <input type="number" name="heart_rate_bpm" placeholder="e.g., 107">
                            </div>
                            <div class="form-field">
                                <label>Systolic BP (mmHg)</label>
                                <input type="number" name="systolic_bp_mmhg" placeholder="e.g., 78">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Diastolic BP (mmHg)</label>
                                <input type="number" name="diastolic_bp_mmhg" placeholder="e.g., 35">
                            </div>
                            <div class="form-field">
                                <label>Temperature (°F)</label>
                                <input type="number" name="temperature_f" placeholder="e.g., 99.1" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Oxygen Saturation (%)</label>
                                <input type="number" name="spo2_pct" placeholder="e.g., 98" min="0" max="100">
                            </div>
                            <div class="form-field">
                                <label>Respiratory Rate</label>
                                <input type="number" name="respiratory_rate" placeholder="e.g., 18">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3><i class="fas fa-flask"></i> Laboratory Values</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Creatinine (mg/dL)</label>
                                <input type="number" name="creatinine_mg_dl" placeholder="e.g., 0.5" step="0.1">
                            </div>
                            <div class="form-field">
                                <label>BUN (mg/dL)</label>
                                <input type="number" name="bun_mg_dl" placeholder="e.g., 8.0" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Hemoglobin (g/dL)</label>
                                <input type="number" name="hemoglobin_g_dl" placeholder="e.g., 10.3" step="0.1">
                            </div>
                            <div class="form-field">
                                <label>WBC Count ($\times 10^3 / \mu L$)</label>
                                <input type="number" name="wbc_count" placeholder="e.g., 6.9" step="0.1">
                            </div>
                        </div>
                    </div>

                        <button type="submit" class="submit-btn">
                            <i class="fas fa-robot"></i>
                            Generate Imaging Protocol
                        </button>
                    </form>
                </div>

                <div id="fhirForm" style="display: none;">
                    <div class="form-group">
                        <h3><i class="fas fa-file-upload"></i> Upload FHIR Data (JSON)</h3>
                        <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.95em;">
                            Upload a FHIR R4 JSON file (Bundle or Patient resource). Clinical data will be automatically extracted.
                        </p>
                        <div id="fileDropZone">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #007bff; margin-bottom: 15px;"></i>
                            <p style="margin: 0; color: #555; font-weight: 500;">**Drop FHIR JSON file here** or click to select</p>
                            <input type="file" id="fhirFileInput" accept=".json" style="display: none;">
                        </div>
                        
                        <div id="fileInfo">
                            <i class="fas fa-file-alt"></i>
                            File Loaded: <span id="fileName"></span>
                            <button type="button" id="clearFile">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                        
                        <button type="button" id="fhirSubmitBtn" class="submit-btn" disabled>
                            <i class="fas fa-server"></i>
                            Process FHIR Data
                        </button>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <div class="results-section">
                <h2 class="section-title">
                    <i class="fas fa-file-prescription"></i>
                    Protocol Recommendations
                </h2>

                <div class="loading" id="loadingIndicator">
                    <i class="fas fa-spinner"></i>
                    <p style="margin-top: 15px; color: #007bff; font-weight: 600;">Analyzing patient data...</p>
                    <small>AI agents are collaborating to generate optimal and safe imaging protocols.</small>
                </div>

                <div class="results-content" id="resultsContent">
                    <div class="result-card">
                        <h4><i class="fas fa-cogs"></i> AI Analysis Summary</h4>
                        <div id="analysisSummary"></div>
                    </div>

                    <div class="result-card" style="border-left: 5px solid #1abc9c;">
                        <h4><i class="fas fa-laptop-medical"></i> Recommended Imaging Protocols</h4>
                        <div id="protocolList"></div>
                    </div>

                    <div class="result-card" style="border-left: 5px solid #f39c12;">
                        <h4><i class="fas fa-brain"></i> Clinical Rationale & Safety Notes</h4>
                        <div id="clinicalRationale"></div>
                    </div>
                </div>

                <div style="text-align: center; color: #7f8c8d; margin-top: 20px;">
                    <small>Recommendations and rationale will appear here after submitting patient information.</small>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; padding: 15px; color: #a0a0a0; font-size: 0.85em;">
            <p>&copy; 2025 AI Medical Protocols. This tool provides recommendations based on AI analysis and **does not replace professional medical judgment**. Always confirm protocols with a certified radiologist.</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('patientForm');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContent = document.getElementById('resultsContent');
        const errorMessage = document.getElementById('errorMessage');
        const submitBtn = form.querySelector('.submit-btn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            resultsContent.style.display = 'none';
            errorMessage.style.display = 'none';
            submitBtn.disabled = true;

            // Collect form data
            const formData = new FormData(form);
            const patientData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    // Convert numeric fields
                    if (['age', 'subject_id', 'heart_rate_bpm', 'systolic_bp_mmhg', 'diastolic_bp_mmhg', 
                         'temperature_f', 'spo2_pct', 'respiratory_rate', 'creatinine_mg_dl', 
                         'bun_mg_dl', 'hemoglobin_g_dl', 'wbc_count'].includes(key)) {
                        patientData[key] = parseFloat(value);
                    } else {
                        patientData[key] = value;
                    }
                }
            }
            
            // Add derived values for backend consistency, if possible
            if (patientData.bun_mg_dl && patientData.creatinine_mg_dl) {
                patientData.bun_creatinine_ratio = patientData.bun_mg_dl / patientData.creatinine_mg_dl;
            }
            patientData.insurance = patientData.insurance || "Other";
            patientData.hospital_expire_flag = 0;
            patientData.data_completeness_pct = 0.95;


            try {
                // Mock API call path - replace with your actual backend endpoint
                const response = await fetch('/run_pipeline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sample_patient: patientData
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `Processing Error: ${error.message}. Please check your input and ensure the backend server is running.`;
                errorMessage.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        function displayResults(result) {
            const { final_output, loops_run } = result;
            
            // Analysis Summary
            document.getElementById('analysisSummary').innerHTML = `
                <p><strong>Analysis completed after ${loops_run || 'N/A'} AI agent iterations.</strong></p>
                <p>A multi-agent system has analyzed the patient data and generated optimized imaging recommendations based on clinical guidelines and the patient's current status.</p>
            `;

            // Protocol List 
            let protocolsHtml = '';
            const protocols = final_output.protocol_selection || [];
            
            if (protocols.length > 0) {
                protocols.forEach((protocol, index) => {
                    // Use fallback names if main properties are missing
                    const protocolName = protocol.name || protocol.protocol_name || `Protocol ${index + 1}`;
                    const indications = Array.isArray(protocol.indications) 
                        ? protocol.indications.join(', ') 
                        : protocol.indications || 'Not specified';
                    
                    // Default to standard notes if not provided
                    const renalNotes = protocol.renal_safety_notes || 'Standard precautions apply. Check eGFR before contrast administration.';

                    protocolsHtml += `
                        <div class="protocol-item">
                            <h5><i class="fas fa-radiation"></i> ${protocolName}</h5>
                            <p><strong>Protocol ID:</strong> ${protocol.protocol_id || 'N/A'}</p>
                            <p><strong>Indications:</strong> ${indications}</p>
                            <p><strong>Description:</strong> ${protocol.description || 'Detailed sequence and imaging parameters.'}</p>
                            <p><strong>Contrast Timing:</strong> ${protocol.contrast_timing || 'Not specified (Consult Imaging Physicist)'}</p>
                            <p><strong>Contrast Dose:</strong> ${protocol.contrast_dose || 'Not specified (Refer to Weight-Based Guidelines)'}</p>
                            <div class="renal-safety-note">
                                <strong>⚠️ Renal Safety Notes:</strong> ${renalNotes}
                            </div>
                        </div>
                    `;
                });
            } else {
                protocolsHtml = '<p class="renal-safety-note" style="background: #fcf8e3; color: #8a6d3b; border-color: #faebcc;">No specific protocols generated. This may indicate the patient data is incomplete, or an initial stabilization/referral is required.</p>';
            }
            document.getElementById('protocolList').innerHTML = protocolsHtml;

            // Clinical Rationale (Recommendations + Rationale)
            let recommendationsHtml = '';
            if (final_output.recommendations && Array.isArray(final_output.recommendations)) {
                recommendationsHtml = '<ul style="padding-left: 20px;">';
                final_output.recommendations.forEach(rec => {
                    recommendationsHtml += `<li style="margin-bottom: 8px;">${rec}</li>`;
                });
                recommendationsHtml += '</ul>';
            } else {
                recommendationsHtml = '<p>No specific procedural recommendations provided.</p>';
            }

            let rationaleHtml = '';
            if (final_output.rationale && Array.isArray(final_output.rationale)) {
                rationaleHtml = '<ul style="padding-left: 20px;">';
                final_output.rationale.forEach(reason => {
                    rationaleHtml += `<li style="margin-bottom: 8px;">${reason}</li>`;
                });
                rationaleHtml += '</ul>';
            } else if (typeof final_output.rationale === 'string') {
                rationaleHtml = `<p>${final_output.rationale}</p>`;
            } else {
                rationaleHtml = '<p>The AI system is unable to provide a detailed rationale at this time. Please ensure all critical lab values are provided.</p>';
            }

            document.getElementById('clinicalRationale').innerHTML = `
                <h5 style="color: #007bff;"><i class="fas fa-check-square"></i> Key Recommendations:</h5>
                ${recommendationsHtml}
                <h5 style="margin-top: 20px; color: #007bff;"><i class="fas fa-microscope"></i> Medical Rationale:</h5>
                ${rationaleHtml}
            `;

            resultsContent.style.display = 'block';
        }

        // --- Standard Form/Sample Data (Retained for testing) ---
        function fillSampleData() {
            const sampleData = {
                subject_id: 10014729,
                age: 21,
                gender: 'F',
                race: 'WHITE - OTHER EUROPEAN',
                admission_type: 'SURGICAL SAME DAY ADMISSION',
                primary_diagnosis: 'Injury to thoracic aorta',
                heart_rate_bpm: 107,
                systolic_bp_mmhg: 78,
                diastolic_bp_mmhg: 35,
                temperature_f: 99.1,
                spo2_pct: 98,
                respiratory_rate: 18,
                creatinine_mg_dl: 0.5,
                bun_mg_dl: 8.0,
                hemoglobin_g_dl: 10.3,
                wbc_count: 6.9
            };

            for (let [key, value] of Object.entries(sampleData)) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = value;
                }
            }
        }

        const sampleBtn = document.createElement('button');
        sampleBtn.type = 'button';
        sampleBtn.className = 'submit-btn';
        sampleBtn.style.background = '#6c757d'; /* Gray for testing */
        sampleBtn.style.marginBottom = '10px';
        sampleBtn.innerHTML = '<i class="fas fa-flask"></i> Load Sample Data (Testing)';
        sampleBtn.onclick = fillSampleData;
        form.insertBefore(sampleBtn, form.querySelector('.submit-btn'));
        // --- End Standard Form/Sample Data ---

        // --- FHIR Mode Functionality (Retained and Enhanced) ---
        const formModeBtn = document.getElementById('formModeBtn');
        const standardForm = document.getElementById('standardForm');
        const fhirForm = document.getElementById('fhirForm');
        const fhirSubmitBtn = document.getElementById('fhirSubmitBtn');
        let isFhirMode = false;

        formModeBtn.addEventListener('click', () => {
            isFhirMode = !isFhirMode;
            if (isFhirMode) {
                standardForm.style.display = 'none';
                fhirForm.style.display = 'block';
                formModeBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Standard Form';
                formModeBtn.style.background = '#e67e22'; /* Orange accent for switch */
            } else {
                standardForm.style.display = 'block';
                fhirForm.style.display = 'none';
                formModeBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to FHIR Format Upload';
                formModeBtn.style.background = '#007bff';
            }
            // Clear results/error on switch
            loadingIndicator.style.display = 'none';
            resultsContent.style.display = 'none';
            errorMessage.style.display = 'none';
        });

        const fileDropZone = document.getElementById('fileDropZone');
        const fhirFileInput = document.getElementById('fhirFileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearFile = document.getElementById('clearFile');
        let uploadedFile = null;

        fileDropZone.addEventListener('click', () => { fhirFileInput.click(); });
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.style.borderColor = '#1abc9c';
            fileDropZone.style.backgroundColor = '#e6f7ff';
        });
        fileDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropZone.style.borderColor = '#007bff';
            fileDropZone.style.backgroundColor = '#f0f8ff';
        });
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.style.borderColor = '#007bff';
            fileDropZone.style.backgroundColor = '#f0f8ff';
            const files = e.dataTransfer.files;
            if (files.length > 0) { handleFileSelect(files[0]); }
        });
        fhirFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) { handleFileSelect(e.target.files[0]); }
        });

        function handleFileSelect(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('Please select a JSON file.');
                return;
            }
            uploadedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            fileDropZone.style.display = 'none';
            fhirSubmitBtn.disabled = false;
        }

        clearFile.addEventListener('click', () => {
            uploadedFile = null;
            fhirFileInput.value = '';
            fileInfo.style.display = 'none';
            fileDropZone.style.display = 'block';
            fhirSubmitBtn.disabled = true;
        });

        fhirSubmitBtn.addEventListener('click', async () => {
            if (!uploadedFile) { alert('Please select a JSON file first'); return; }

            try {
                const fileContent = await readFileAsText(uploadedFile);
                const fhirData = JSON.parse(fileContent);
                const extractedData = extractDataFromFHIR(fhirData);
                
                loadingIndicator.style.display = 'block';
                resultsContent.style.display = 'none';
                errorMessage.style.display = 'none';
                fhirSubmitBtn.disabled = true;

                const response = await fetch('/run_pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ sample_patient: extractedData })
                });

                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `Error processing FHIR data: ${error.message}. Check file format and backend connection.`;
                errorMessage.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none';
                fhirSubmitBtn.disabled = uploadedFile ? false : true;
            }
        });

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // The core data extraction logic from FHIR is complex and retained as-is
        function extractDataFromFHIR(fhirData) {
            const extracted = {};
            let patient, encounter, conditions = [], labObs = [], vitalObs = [];

            // Handle Bundle vs single Patient resource
            if (fhirData.resourceType === "Bundle" && fhirData.entry) {
                fhirData.entry.forEach(entry => {
                    const resource = entry.resource;
                    switch(resource.resourceType) {
                        case "Patient": patient = resource; break;
                        case "Encounter": encounter = resource; break;
                        case "Condition": conditions.push(resource); break;
                        case "Observation":
                            if (resource.category?.some(cat => cat.coding?.some(code => code.code === "laboratory"))) {
                                labObs.push(resource);
                            } else if (resource.category?.some(cat => cat.coding?.some(code => code.code === "vital-signs"))) {
                                vitalObs.push(resource);
                            } break;
                    }
                });
            } else if (fhirData.resourceType === "Patient") {
                patient = fhirData;
            }

            // Extract Patient data
            if (patient) {
                if (patient.id) extracted.subject_id = parseInt(patient.id) || 0;
                if (patient.gender) extracted.gender = patient.gender.toUpperCase().charAt(0);
                if (patient.birthDate) {
                    const birthDate = new Date(patient.birthDate);
                    const today = new Date();
                    extracted.age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
                }
                if (patient.extension) {
                    patient.extension.forEach(ext => {
                        if (ext.url === "http://hl7.org/fhir/StructureDefinition/patient-race") { extracted.race = ext.valueString; }
                    });
                }
            }

            // Extract Encounter data
            if (encounter) {
                if (encounter.type?.[0]?.text) extracted.admission_type = encounter.type[0].text;
            }

            // Extract Conditions
            if (conditions.length > 0) {
                extracted.primary_diagnosis = conditions[0].code?.text || conditions[0].code?.coding?.[0]?.display;
            }

            // Simplified Lab and Vital Extraction (Logic retained from original)
            const mapData = (obsList, unitMap) => {
                obsList.forEach(obs => {
                    const components = obs.component || [{ code: obs.code, valueQuantity: obs.valueQuantity }];
                    components.forEach(comp => {
                        const name = comp.code?.text?.toLowerCase();
                        const value = comp.valueQuantity?.value;
                        if (name && value !== undefined) {
                            switch(name) {
                                case "creatinine": extracted.creatinine_mg_dl = value; break;
                                case "bun": extracted.bun_mg_dl = value; break;
                                case "hemoglobin": extracted.hemoglobin_g_dl = value; break;
                                case "wbc": extracted.wbc_count = value; break;
                                case "heart rate": extracted.heart_rate_bpm = value; break;
                                case "systolic bp": extracted.systolic_bp_mmhg = value; break;
                                case "diastolic bp": extracted.diastolic_bp_mmhg = value; break;
                                case "temperature": extracted.temperature_f = value; break;
                                case "spo₂": extracted.spo2_pct = value; break;
                                case "respiratory rate": extracted.respiratory_rate = value; break;
                                // Additional mappings if needed:
                                // case "egfr (ckd-epi)": extracted.egfr_ckd_epi = value; break; 
                            }
                        }
                    });
                });
            };

            mapData(labObs);
            mapData(vitalObs);

            // Calculate derived values and set defaults (critical for backend compatibility)
            if (extracted.bun_mg_dl && extracted.creatinine_mg_dl) {
                extracted.bun_creatinine_ratio = extracted.bun_mg_dl / extracted.creatinine_mg_dl;
            }
            extracted.insurance = extracted.insurance || "Other";
            extracted.hospital_expire_flag = 0;
            extracted.data_completeness_pct = 0.95;
            
            return extracted;
        }

        // Sample FHIR data creation button (retained)
        function loadSampleFHIR() {
            const sampleData = {
                "resourceType": "Bundle",
                "type": "collection",
                "entry": [
                    {
                        "resource": {
                            "resourceType": "Patient",
                            "id": "10014729",
                            "gender": "female",
                            "birthDate": "2002-01-01",
                            "extension": [
                                { "url": "http://hl7.org/fhir/StructureDefinition/patient-race", "valueString": "WHITE - OTHER EUROPEAN" }
                            ]
                        }
                    },
                    {
                        "resource": {
                            "resourceType": "Encounter",
                            "id": "28889419",
                            "status": "finished",
                            "type": [{ "text": "SURGICAL SAME DAY ADMISSION" }],
                            "subject": { "reference": "Patient/10014729" }
                        }
                    },
                    {
                        "resource": {
                            "resourceType": "Condition",
                            "id": "cond1",
                            "subject": { "reference": "Patient/10014729" },
                            "code": { "text": "Injury to thoracic aorta" },
                            "clinicalStatus": { "coding": [{ "system": "http://terminology.hl7.org/CodeSystem/condition-clinical", "code": "active" }] }
                        }
                    },
                    {
                        "resource": {
                            "resourceType": "Observation",
                            "id": "obs-labs",
                            "status": "final",
                            "category": [{ "coding": [{ "system": "http://terminology.hl7.org/CodeSystem/observation-category", "code": "laboratory" }] }],
                            "subject": { "reference": "Patient/10014729" },
                            "component": [
                                { "code": { "text": "Creatinine" }, "valueQuantity": { "value": 0.5, "unit": "mg/dL" } },
                                { "code": { "text": "BUN" }, "valueQuantity": { "value": 8.0, "unit": "mg/dL" } },
                                { "code": { "text": "Hemoglobin" }, "valueQuantity": { "value": 10.3, "unit": "g/dL" } },
                            ]
                        }
                    },
                    {
                        "resource": {
                            "resourceType": "Observation",
                            "id": "obs-vitals",
                            "status": "final",
                            "category": [{ "coding": [{ "system": "http://terminology.hl7.org/CodeSystem/observation-category", "code": "vital-signs" }] }],
                            "subject": { "reference": "Patient/10014729" },
                            "component": [
                                { "code": { "text": "Heart rate" }, "valueQuantity": { "value": 107, "unit": "bpm" } },
                                { "code": { "text": "Systolic BP" }, "valueQuantity": { "value": 78, "unit": "mmHg" } },
                                { "code": { "text": "Diastolic BP" }, "valueQuantity": { "value": 35, "unit": "mmHg" } },
                                { "code": { "text": "Temperature" }, "valueQuantity": { "value": 99.1, "unit": "°F" } }
                            ]
                        }
                    }
                ]
            };
            
            const blob = new Blob([JSON.stringify(sampleData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample-fhir-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        const sampleFhirBtn = document.createElement('button');
        sampleFhirBtn.type = 'button';
        sampleFhirBtn.className = 'submit-btn';
        sampleFhirBtn.style.background = '#9b59b6'; /* Purple for download */
        sampleFhirBtn.style.marginTop = '10px';
        sampleFhirBtn.innerHTML = '<i class="fas fa-download"></i> Download Sample FHIR File';
        sampleFhirBtn.onclick = loadSampleFHIR;
        fhirForm.appendChild(sampleFhirBtn);
        // --- End FHIR Mode Functionality ---
    </script>
</body>
</html>